#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
[include RatOS.cfg]
##IDEX MOD
[include RatOS/printers/v-core-3-idex/v-core-3.cfg]
[include RatOS/printers/v-core-3-idex/500.cfg]
[include RatOS/printers/v-core-3-idex/macros.cfg]
#[include RatOS/macros/idex/toolheads.cfg]
#[include RatOS/macros/idex/idex.cfg]
#[include RatOS/macros/idex/overrides.cfg]
#[include RatOS/macros.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: True
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_nozzle_prime_start_x1:420
#variable_printable_x_max:420
variable_start_print_park_in: "back"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_macro_travel_speed: 600
variable_macro_travel_accel: 8000

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
#------------------------------------------------------------------------------------------------------------
[tmc2209 stepper_x]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC4
run_current: 1.6
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 0
sense_resistor: 0.11

[stepper_x]
step_pin:PF13
dir_pin:PF12              # Add ! in front of pin name to reverse the direction of stepper_x
enable_pin:!PF14
#uart_pin:PC4
#diag_pin:PG6
endstop_pin:PG6           
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 420
position_endstop: 0

[tmc2209 dual_carriage]
stealthchop_threshold: 0
interpolate: False
uart_pin: PD11
run_current: 1.6
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 0
sense_resistor: 0.11

[dual_carriage]
step_pin:PG0
dir_pin:PG1
enable_pin:!PF15
#uart_pin:PD11
#diag_pin:PG10
endstop_pin:PG10
rotation_distance: 40
homing_speed: 50
microsteps: 64
position_max: 500
position_endstop: 500
position_min: 60

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
#------------------------------------------------------------------------------------------------------------

[tmc2209 stepper_y]
stealthchop_threshold: 0
interpolate: False
uart_pin: PC6
run_current: 1.6
driver_TBL: 1
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 0
sense_resistor: 0.11

[stepper_y]
step_pin:PF11
dir_pin:!PG3               # Add ! in front of pin name to reverse the direction of stepper_y
enable_pin:!PG5
endstop_pin:PG9      
rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 500
position_endstop: 500

#[tmc2209 stepper_y1]  #uncomment if you have wired in 9th driver or your controller supports more than 8
#stealthchop_threshold: 0
#interpolate: False
#uart_pin: PA9
#run_current: 1.6
#driver_TBL: 1
#driver_TOFF: 3
#driver_HEND: 0
#driver_HSTRT: 0
#sense_resistor: 0.11

#[stepper_y1]  #uncomment if you have wired in 9th driver or your controller supports more than 8
#step_pin:PE9
#dir_pin:PE12               # Add ! in front of pin name to reverse the direction of stepper_y
#enable_pin:!PE8
#endstop_pin:PG9      
#rotation_distance: 40     # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
#microsteps: 64

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4      # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 500
[tmc2209 stepper_z]
run_current: 1.1

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: !z1_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4      # 4 for TR8*4 lead screws
[tmc2209 stepper_z1]
run_current: 1.1


#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin      # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4      # 4 for TR8*4 lead screws
[tmc2209 stepper_z2]
run_current: 1.1

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: e_dir_pin       # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 5.57   # Bondtech LGX Lite default
pressure_advance: 0.06   # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
control: pid
pid_kp: 28.413
pid_ki: 1.334
pid_kd: 151.300

[tmc2209 extruder1]
stealthchop_threshold: 0
interpolate: False
uart_pin: PF2
run_current: 0.707
driver_TBL: 0
driver_TOFF: 4
driver_HEND: 6
driver_HSTRT: 7
sense_resistor: 0.11

[extruder1]
step_pin:PF9
dir_pin:PF10
enable_pin:!PG2
microsteps:64
rotation_distance: 5.57
full_steps_per_rotation: 200
filament_diameter: 1.750
max_extrude_only_velocity: 120
max_extrude_only_accel: 800
pressure_advance_smooth_time: 0.02
# T1 E3D V6 definition (from RatOS/hotends/v6.cfg)
max_extrude_only_distance: 200
nozzle_diameter: 0.4
heater_pin: PA3
max_power:0.5
sensor_type: ATC Semitec 104GT-2
sensor_pin: PF5
control: pid
pid_kp: 28.413
pid_ki: 1.334
pid_kd: 151.300
min_extrude_temp: 170
min_temp: 0
max_temp: 285
pressure_advance: 0.06

# printer max velocity settings
[printer]
max_velocity: 600
max_accel: 15000
#max_accel_to_decel: 7500
max_z_velocity: 20
max_z_accel: 150
#square_corner_velocity: 10

[dual_carriage]
safe_distance: 70

[exclude_object]

#[adxl345]
#spi_software_sclk_pin: PB3
#spi_software_mosi_pin: PB5
#spi_software_miso_pin: PB4
#cs_pin: PA15


[heater_bed]
control: pid
pid_Kp: 22.2
pid_Ki: 1.08
pid_Kd: 114

[bed_mesh]
horizontal_move_z: 5
mesh_min: 20,20
mesh_max:380,460
probe_count: 7,7
fade_start: 1.0
fade_end: 10.0
mesh_pps: 2,2
algorithm: bicubic
bicubic_tension: .2

[z_tilt]
z_positions:
	0,0
	250,500
	420,0

points:
	60,60
	285,470
	420,60

# Probe configuration
[probe]
z_offset: 0.85 # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG
pin: ^probe_pin # For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
#pin: ^!probe_pin # NPN NO (refer to the specs of your probe)
#pin: probe_pin # PNP NO (refer to the specs of your probe)
#pin: !probe_pin # PNP NC (refer to the specs of your probe)
[duplicate_pin_override]
pins:PA8

[fan]
pin: PD15 # sacrifical part fan, use this to independently control your both toolhead part fans
[fan_generic part_fan_t0]
pin: PA8 # 2-pin fan connected to 2-pin header on Octopus Pro H723 - input voltage pwm
[fan_generic part_fan_t1]
pin: PD14 # 2-pin fan connected to 2-pin header on Octopus Pro H723 - input voltage pwm
#cycle_time:  0.00004

# Hotend cooling fan
[heater_fan toolhead_cooling_fan]
heater: extruder
# 2-pin fan connected to 2-pin header on Octopus Pro H723 - input voltage pwm
pin: PE5
[heater_fan toolhead_cooling_fan_t1]
heater: extruder1
# 2-pin fan connected to 2-pin header on T1 (EBB42 v1.2) - input voltage pwm
pin: PD13


[gcode_macro T0]
variable_join: 0
variable_remap: 0
variable_alert: ""
variable_filament_name: ""
variable_filament_type: ""
variable_filament_temp: 0
variable_runout_sensor: ""
variable_active: True
variable_color: "7bff33"                                  # Used in frontends
variable_hotend_type: "SF"
variable_has_cht_nozzle: False
variable_cooling_position_to_nozzle_distance: 40          # heatbreak length from cold zone to nozzle
variable_tooolhead_sensor_to_extruder_gear_distance: 15   # distance in mm from the sensor to the extruder gear
variable_extruder_gear_to_cooling_position_distance: 30   # distance in mm from the extruder gear to the end of the hotend cold zone
variable_filament_loading_nozzle_offset: -5
variable_filament_grabbing_length: 5
variable_filament_grabbing_speed: 1
variable_enable_insert_detection: True                    # enables filament sensor insert detection 
variable_enable_runout_detection: True                    # enables filament sensor runout detection 
variable_enable_clog_detection: True                      # enables filament sensor clog detection 
variable_unload_after_runout: True                        # unload filament after a runout has been detected
variable_purge_after_load: 0
variable_purge_before_unload: 0
variable_extruder_load_speed: 60
variable_filament_load_speed: 10
variable_standby: False
variable_temperature_offset: 0                            # hotend temperature offset
variable_has_oozeguard: False                             # toolhead has a oozeguard
variable_has_front_arm_nozzle_wiper: False                # toolhead has front arm nozzle wipers
variable_loading_position: 5                          # filament load x position
variable_parking_position: 5                          # parking x position
variable_resume_after_insert: True                        # resumes the print after inserting new filament
gcode:
	{% set x = params.X|default(-1.0)|float %}
	{% set y = params.Y|default(-1.0)|float %}
	{% set z = params.Z|default(0.0)|float %}
	{% set s = params.S|default(1)|int %}
	{% if printer["gcode_macro _SELECT_TOOL"] is defined %}
		_SELECT_TOOL T=0 X={x} Y={y} Z={z} TOOLSHIFT={s}
	{% endif %}
[gcode_macro T1]
variable_join: 0
variable_remap: 0
variable_alert: ""
variable_filament_name: ""
variable_filament_type: ""
variable_filament_temp: 0
variable_runout_sensor: ""
variable_active: False
variable_color: "0ea5e9"                                  # Used in frontends
variable_hotend_type: "SF"
variable_has_cht_nozzle: False
variable_cooling_position_to_nozzle_distance: 40          # heatbreak length from cold zone to nozzle
variable_tooolhead_sensor_to_extruder_gear_distance: 15   # distance in mm from the sensor to the extruder gear
variable_extruder_gear_to_cooling_position_distance: 30   # distance in mm from the extruder gear to the end of the hotend cold zone
variable_filament_loading_nozzle_offset: -5
variable_filament_grabbing_length: 5
variable_filament_grabbing_speed: 1
variable_enable_insert_detection: True                    # enables filament sensor insert detection 
variable_enable_runout_detection: True                    # enables filament sensor runout detection 
variable_enable_clog_detection: True                      # enables filament sensor clog detection 
variable_unload_after_runout: True                        # unload filament after a runout has been detected
variable_purge_after_load: 0
variable_purge_before_unload: 0
variable_extruder_load_speed: 60
variable_filament_load_speed: 10
variable_standby: False
variable_temperature_offset: 0                            # hotend temperature offset
variable_has_oozeguard: False                             # toolhead has a oozeguard
variable_has_front_arm_nozzle_wiper: False                # toolhead has front arm nozzle wipers
variable_loading_position: 495                          # filament load x position
variable_parking_position: 495                          # parking x position
variable_resume_after_insert: True                        # resumes the print after inserting new filament
gcode:
	{% set x = params.X|default(-1.0)|float %}
	{% set y = params.Y|default(-1.0)|float %}
	{% set z = params.Z|default(0.0)|float %}
	{% set s = params.S|default(1)|int %}
	{% if printer["gcode_macro _SELECT_TOOL"] is defined %}
		_SELECT_TOOL T=1 X={x} Y={y} Z={z} TOOLSHIFT={s}
	{% endif %}

# Macro variable overrides
[gcode_macro RatOS]
variable_bed_margin_x: [73.5, 73.5]
variable_bed_margin_y: [0, 0]
variable_default_toolhead: 0                           # the toolhead with the z-probe, 0=left 1=right toolhead
variable_adxl_chip: ["controlboard"]                   # toolheads adxl chip names
variable_toolchange_travel_speed: 300                  # parking travel speed
variable_toolchange_travel_accel: 3000                 # parking travel accel
variable_shaper_x_freq: [0, 0, 0, 0]                   # shaper frequency [T0, T1, COPY, MIRROR]
variable_shaper_y_freq: [0, 0, 0, 0]                   # shaper frequency [T0, T1, COPY, MIRROR]
variable_shaper_x_type: ["mzv", "mzv", "mzv", "mzv"]   # shaper frequency algorythm [T0, T1, COPY, MIRROR]
variable_shaper_y_type: ["mzv", "mzv", "mzv", "mzv"]   # shaper frequency algorythm [T0, T1, COPY, MIRROR]
variable_x_driver_types: ["tmc2209"]
variable_x_axes: ["x"]
variable_y_driver_types: ["tmc2209"]
variable_y_axes: ["y"]
variable_z_driver_types: ["tmc2209", "tmc2209", "tmc2209"]
variable_z_axes: ["z", "z1", "z2"]
variable_home_y_first: True
